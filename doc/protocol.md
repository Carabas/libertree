# Social Network Protocol

## Introduction

This document describes the behaviour of servers that are members of the
social network.

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD",
"SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be
interpreted as described in RFC 2119.

## Connectivity

Servers MUST listen on TCP port 14404. Connections made from one server to
another MUST be made to this port.

## Request Protocol

For any connection, the server that initiates the connection is the requester,
and the server that receives the connection is the responder.  Messages sent
from a requester to a responder are called requests.  Messages sent from a
responder to a requester are called responses.

All messages sent through a connection, in either direction, whether requests
or responses, MUST be terminated with a newline character (ASCII 13). All
messages MUST NOT contain any newline characters.  Messages MUST be encoded in
UTF-8. All message contents, including structures (arrays and hashes) MUST be
valid JSON structures.

## Server Authentication

Every server MUST have a pair of encryption keys: one private and one public.
A server's public key constitutes its unique identity.  Every connection made
from a requester to a responder MUST begin with an INTRODUCE request.  A
responder MUST NOT process any requests until the requester has successfully
authenticated via the INTRODUCE and/or AUTHENTICATE requests.  A responder MUST
respond with a "NOT AUTHENTICATED" code to any requests (other than INTRODUCE
and AUTHENTICATE) from a requester that is not authenticated.  A responder MAY
close the connection after responding with a "NOT AUTHENTICATED" code.

## Requests

In the following descriptions, required components are indicated with angle
brackets (<>). Optional components are indicated with double square brackets
([[]]). Multiple possibilities are indicated by separating them with a pipe
character (|). Otherwise, the structures given are to be considered normative
literal JSON data.

Requests are sent through the socket in this format:

    <request command> <JSON data>

For example:

    INTRODUCE { 'public_key' => "-----BEGIN PGP PUBLIC KEY BLOCK-----\n..." }

### INTRODUCE

Request Parameters:

    { 'public_key' => <public key> }

Response Structure:

    { 'code' => 'OK' }
    |
    {
      'code' => 'OK',
      'challenge' => <challenge>
    }

The first request sent through every connection is the INTRODUCE request.

If the responder has no record of a server having the given public key, the
responder MUST store the public key and the requester's IP address.  The
responder responds with an OK code, and MUST consider the requester
authenticated for the remainder of the connection's lifetime.

If the responder has a record of the given public key, the responder generates
a random string which MUST be at least 16 characters long, and encrypts it
using the public key.  It then responds with an OK code together with the
encrypted string.  The requester MUST then issue an AUTHENTICATE request.

The random string used for the challenge SHOULD NOT be the same as one used in
any previous connection, whether with the same requester or a different one.

### AUTHENTICATE

Request Parameters:

    { 'response' => <challenge response> }

Response Structure:

    { 'code' => 'OK' }
    |
    {
      'code' => 'ERROR',
      [[ 'message' => <explanatory text> ]]
    }

The requester, after receiving an INTRODUCE challenge from the responder, MUST
decrypt the challenge string using its (the requester's) private key, and
issue an AUTHENTICATE request with the decrypted text.

If the challenge response matches the original (unencrypted) challenge string
generated by the responder, then the responder MUST respond with an OK code,
and consider the requester authenticated for the remainder of the connection's
lifetime.

If the challenge response does not match the original challenge string, then
the responder MUST respond with an ERROR code.  The responder MAY provide a
'message' element containing text that would assist a human in debugging.
The responder MAY close the connection after the failed challenge.

### NEW-IP

Request Parameters:

    { 'ip' => <new IP> }

Response Structure:

    { 'code' => 'OK' }

A requester uses NEW-IP to inform the responder that its IP has changed.  The
responder MUST update its records for the requester's pubkey with the new IP.
